name: Publish to Chrome Web Store

on:
  push:
    branches:
      - main # Or your primary branch if different

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bump Version in manifest.json
        id: bump_version
        run: |
          MANIFEST_PATH="manifest.json" # Files are now at the root
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "Error: manifest.json not found at $MANIFEST_PATH. Current directory contents:"
            ls -la
            exit 1
          fi
          TMP_MANIFEST="/tmp/m.tmp"
          # Ensure current_version is correctly fetched before attempting to increment
          current_version_val=$(jq -r .version "$MANIFEST_PATH")
          if [ -z "$current_version_val" ] || [ "$current_version_val" == "null" ]; then
            echo "Error: Could not read current version from $MANIFEST_PATH. Content:"
            cat "$MANIFEST_PATH"
            exit 1
          fi
          jq --arg current_version "$current_version_val" \
             '.version = ($current_version | split(".") | .[0] + "." + .[1] + "." + ((.[2]|tonumber)+1|tostring))' \
             "$MANIFEST_PATH" > "$TMP_MANIFEST" && mv "$TMP_MANIFEST" "$MANIFEST_PATH"
          
          NEW_VERSION=$(jq -r .version "$MANIFEST_PATH")
          echo "New version: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Inject default API keys (GitHub Secrets → placeholders)
        run: |
          # Replace placeholder API keys with real keys from GitHub Secrets
          # so the published extension works out of the box for end users.
          # Source code on GitHub never contains the real keys.
          if [ -n "$ESV_API_KEY" ]; then
            sed -i "s|__ESV_API_KEY_PLACEHOLDER__|${ESV_API_KEY}|g" bibles.json
            echo "✓ ESV API key injected"
          else
            echo "⚠ ESV_API_KEY secret not set — users will need to provide their own"
          fi
          if [ -n "$BIBLE_API_KEY" ]; then
            sed -i "s|__BIBLE_API_KEY_PLACEHOLDER__|${BIBLE_API_KEY}|g" bibles.json
            echo "✓ api.bible key injected"
          else
            echo "⚠ BIBLE_API_KEY secret not set — users will need to provide their own"
          fi
        env:
          ESV_API_KEY: ${{ secrets.ESV_API_KEY }}
          BIBLE_API_KEY: ${{ secrets.BIBLE_API_KEY }}
        shell: bash

      - name: Create ZIP file
        run: |
          # Package only extension files. Including node_modules/test/etc causes 400 from Chrome Web Store API.
          zip -r extension.zip . \
            -x ".git*" \
            -x ".github/*" \
            -x "node_modules/*" \
            -x "test/*" \
            -x "*.DS_Store" \
            -x "package.json" \
            -x "package-lock.json" \
            -x "*.md" \
            -x ".gitignore" \
            -x "Downloads/*"
          echo "ZIP size: $(du -h extension.zip | cut -f1)"
        shell: bash

      - name: Upload to Chrome Web Store
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: extension.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: false

      - name: Commit and Push Version Bump
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add manifest.json # Path is now direct (root)
          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "Bump version to ${{ steps.bump_version.outputs.VERSION }} [skip ci]"
            git push
          else
            echo "No changes to commit for version bump (manifest.json likely unchanged)."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
